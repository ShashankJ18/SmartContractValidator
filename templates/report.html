<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audit Report – {{ report.filename }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .gauge-wrap { position: relative; width: 260px; height: 260px; margin: 0 auto; }
    .gauge-center { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; }
    pre.code { background:#111; color:#0f0; padding:12px; border-radius:8px; max-height:260px; overflow:auto; }
    .status-PASS { color:#0a7b26; font-weight:600; }
    .status-PARTIAL { color:#b08000; font-weight:600; }
    .status-FAIL { color:#b00020; font-weight:700; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Audit Report – <span class="text-muted">{{ report.filename }}</span></h1>
      <div class="d-flex gap-2">
        <form method="POST" action="/download/json"><button class="btn btn-outline-secondary">⬇️ JSON</button></form>
        <form method="POST" action="/download/pdf"><button class="btn btn-primary">⬇️ PDF</button></form>
      </div>
    </div>

    <!-- Top cards: Gauge + Contributions + Logs -->
    <div class="row g-3 mb-4">
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Overall Score</h5>
            <div class="gauge-wrap">
              <canvas id="gauge"></canvas>
              <div class="gauge-center">{{ report.overall_score }}<span class="fs-6">/100</span></div>
            </div>
            <p class="mt-3 mb-0"><b>Verdict:</b> {{ report.verdict }}</p>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Aspect Contributions</h5>
            <canvas id="contrib"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Debug Logs</h5>
            <pre class="code">{{ logs }}</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Radar of aspect scores -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Aspect Scores</h5>
        <canvas id="radar"></canvas>
      </div>
    </div>

    <!-- Detailed aspect breakdown -->
    <div class="accordion" id="aspectAccordion">
      {% for aspect_name, data in report.aspects.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
          <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
            <div class="me-3 fw-bold">{{ aspect_name }}</div>
            <div>Score: <b>{{ data.score_percent }}%</b> ({{ data.score_raw }} / {{ data.score_max }}) &nbsp;•&nbsp; Weight: {{ data.weight }}</div>
          </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {{ 'show' if loop.first }}" data-bs-parent="#aspectAccordion">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Parameter</th>
                    <th class="text-end">Weight</th>
                    <th>Status</th>
                    <th class="text-end">Points</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in data.parameters %}
                  <tr>
                    <td><code>{{ p.key }}</code></td>
                    <td class="text-end">{{ p.weight }}</td>
                    <td class="fw-semibold status-{{ p.status }}">{{ p.status }}</td>
                    <td class="text-end">{{ p.points }}</td>
                    <td style="max-width: 680px;">{{ p.reason }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <details class="mt-3">
              <summary class="mb-2">Show raw model output</summary>
              <pre class="code">{{ data.llm_raw }}</pre>
            </details>

            {% if data.missing and data.missing|length %}
              <div class="alert alert-warning mt-3">
                <strong>Note:</strong> Model did not address parameters: {{ data.missing | join(', ') }}.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Source code panel -->
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <h5 class="card-title">Source Code</h5>
        <pre class="code">{{ report.code }}</pre>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Gauge (doughnut) for overall score
    const gaugeCtx = document.getElementById('gauge').getContext('2d');
    new Chart(gaugeCtx, {
      type: 'doughnut',
      data: { labels: ['Score','Remaining'], datasets: [{ data: [{{ report.overall_score }}, {{ 100 - report.overall_score }}] }] },
      options: { cutout: '70%', plugins: { legend: { display:false } } }
    });

    // Contributions stacked bar
    const contribCtx = document.getElementById('contrib').getContext('2d');
    const contribLabels = {{ report.contributions | map(attribute='aspect') | list | tojson }};
    const contribData = {{ report.contributions | map(attribute='contribution') | list | tojson }};
    new Chart(contribCtx, {
      type: 'bar',
      data: { labels: contribLabels, datasets: [{ label: 'Contribution to overall (out of 100)', data: contribData }] },
      options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Radar chart of aspect percents
    const radarCtx = document.getElementById('radar').getContext('2d');
    const radarLabels = contribLabels;
    const radarPercents = {{ report.contributions | map(attribute='percent') | list | tojson }};
    new Chart(radarCtx, {
      type: 'radar',
      data: { labels: radarLabels, datasets: [{ label: 'Aspect Percent Scores', data: radarPercents, fill: true }] },
      options: { scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
    });
  </script>
</body>
</html>
